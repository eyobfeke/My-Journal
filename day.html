<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Daily Journal</title>
  <link rel="stylesheet" href="../style.css" />
  <style>
    :root {
      --accent: #007bff;
      --card-bg: #ffffff;
      --muted: #666;
    }

    body {
      font-family: "Segoe UI", system-ui, sans-serif;
      margin: 0;
      padding: 0;
      background: transparent;
      color: inherit;
    }

    header {
      text-align: center;
      padding: 16px;
      border-bottom: 1px solid rgba(0,0,0,0.06);
    }

    header a.back {
      display: inline-block;
      color: var(--accent);
      text-decoration: none;
      font-weight: 600;
      margin-top: 5px;
    }

    main.container {
      max-width: 980px;
      margin: 20px auto;
      padding: 20px;
      background: var(--card-bg);
      border-radius: 10px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.06);
    }

    #trade-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
    }

    #trade-table th, #trade-table td {
      border: 1px solid rgba(0,0,0,0.12);
      padding: 8px;
      text-align: center;
    }

    #trade-table th {
      background: rgba(0,0,0,0.03);
      font-weight: 700;
    }

    .btn {
      padding: 8px 12px;
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
    }

    textarea, input[type="text"] {
      width: 100%;
      box-sizing: border-box;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid rgba(0,0,0,0.12);
      font-family: inherit;
      font-size: 14px;
      background: #fff;
      color: inherit;
    }

    textarea { min-height: 110px; resize: vertical; }

    body.dark textarea, body.dark input[type="text"] {
      background: #222;
      color: #eaeaea;
      border-color: rgba(255,255,255,0.1);
    }

    .screenshot-preview {
      display: block;
      max-width: 140px;
      max-height: 120px;
      object-fit: cover;
      border-radius: 6px;
      margin-top: 8px;
      cursor: zoom-in;
      border: 1px solid rgba(0,0,0,0.08);
    }

    .modal {
      display: none;
      position: fixed;
      z-index: 1200;
      inset: 0;
      background: rgba(0,0,0,0.85);
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .modal img {
      max-width: 95%;
      max-height: 95%;
      border-radius: 8px;
    }

    .small-meta {
      text-align: right;
      color: var(--muted);
      font-size: 13px;
    }

    section { margin-bottom: 20px; }

    h2.section-title {
      font-size: 16px;
      margin-bottom: 8px;
    }

    @media (max-width:720px){
      main.container { margin: 12px; padding: 12px; }
    }
  </style>
</head>
<body>
  <header>
    <h1 id="entry-date">Loading...</h1>
    <a class="back" href="../index.html">‚Üê Back to Calendar</a>
  </header>

  <main class="container">
    <!-- Trade Detail Table -->
    <section id="trade-section">
      <button id="add-trade" class="btn">Add Trade</button>
      <table id="trade-table">
        <thead>
          <tr>
            <th>Pair</th>
            <th>Entry</th>
            <th>Exit</th>
            <th>R:R</th>
            <th>Notes</th>
            <th>PNL</th>
            <th>Screenshot</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- Daily Journal Sections -->
    <section id="daily-summary">
      <h2 class="section-title">Daily Summary</h2>
      <textarea id="dailySummary" placeholder="Automatically filled summary of today‚Äôs trades..."></textarea>
    </section>

    <section id="mood-section">
      <h2 class="section-title">Mood Tracker</h2>
      <label><input type="radio" name="mood" value="Happy"> Happy</label>
      <label><input type="radio" name="mood" value="Neutral"> Neutral</label>
      <label><input type="radio" name="mood" value="Sad"> Sad</label>
      <label><input type="radio" name="mood" value="Stressed"> Stressed</label>
      <label><input type="radio" name="mood" value="Confident"> Confident</label>
    </section>

    <section id="reflection-section">
      <h2 class="section-title">Reflection</h2>
      <textarea id="reflection" placeholder="Write your reflections for the day..."></textarea>
      <div class="small-meta"><span id="wordCount">Words: 0</span></div>
    </section>

    <section id="gratitude-section">
      <h2 class="section-title">Gratitude List</h2>
      <textarea id="gratitude" placeholder="List things you‚Äôre grateful for today..."></textarea>
    </section>

    <section id="goals-section">
      <h2 class="section-title">Daily Goals</h2>
      <textarea id="goals" placeholder="What are your goals for tomorrow?"></textarea>
    </section>

    <button id="saveEntry" class="btn">üíæ Save Entry</button>
  </main>

  <div id="imgModal" class="modal"><img id="modalImg" alt=""></div>

  <script>
    const params = new URLSearchParams(window.location.search);
    const date = params.get('date') || new Date().toISOString().slice(0,10);
    document.getElementById('entry-date').textContent = `Journal for ${date}`;
    const STORAGE_KEY = `entry-${date}`;

    const tbody = document.querySelector("#trade-table tbody");
    const addTradeBtn = document.getElementById("add-trade");
    const saveBtn = document.getElementById("saveEntry");
    const summaryEl = document.getElementById("dailySummary");
    const reflectionEl = document.getElementById("reflection");
    const gratitudeEl = document.getElementById("gratitude");
    const goalsEl = document.getElementById("goals");
    const wordCountEl = document.getElementById("wordCount");

    const modal = document.getElementById("imgModal");
    const modalImg = document.getElementById("modalImg");

    addTradeBtn.onclick = () => createTradeRow();

    function createTradeRow(data = {}) {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><input class="pair" value="${data.pair||''}" placeholder="Pair"></td>
        <td><input class="entry" value="${data.entry||''}" placeholder="Entry"></td>
        <td><input class="exit" value="${data.exit||''}" placeholder="Exit"></td>
        <td><input class="rr" value="${data.rr||''}" placeholder="R:R"></td>
        <td><textarea class="notes" placeholder="Notes...">${data.notes||''}</textarea></td>
        <td><input class="pnl" value="${data.pnl||''}" placeholder="+50/-20"></td>
        <td>
          <input type="file" accept="image/*" class="shot">
          <img src="${data.screenshot||''}" class="screenshot-preview" style="display:${data.screenshot?'block':'none'}">
        </td>`;
      const shot = tr.querySelector(".shot");
      const img = tr.querySelector(".screenshot-preview");
      shot.onchange = e => {
        const f = e.target.files[0];
        if(!f) return;
        const reader = new FileReader();
        reader.onload = ev => {
          img.src = ev.target.result;
          img.style.display = "block";
          img.dataset.base64 = ev.target.result;
        };
        reader.readAsDataURL(f);
      };
      img.onclick = () => openModal(img.src);
      tbody.appendChild(tr);
    }

    function openModal(src){
      modalImg.src = src;
      modal.style.display="flex";
    }
    modal.onclick = ()=> modal.style.display="none";

    function getTrades(){
      return [...tbody.querySelectorAll("tr")].map(tr=>{
        const get=(s)=>tr.querySelector(s)?.value||"";
        const img=tr.querySelector(".screenshot-preview");
        return {
          pair:get(".pair"), entry:get(".entry"), exit:get(".exit"),
          rr:get(".rr"), notes:get(".notes"), pnl:get(".pnl"),
          screenshot:img?.dataset.base64||img?.src||""
        };
      });
    }

    function autoSummary(trades){
      if(!trades.length) return "No trades recorded today.";
      let totalPNL=0, rrSum=0, rrCount=0;
      let list=[];
      for(const t of trades){
        const n=parseFloat(t.pnl)||0;
        totalPNL+=n;
        const r=parseFloat(t.rr?.split(':')[1])||0;
        if(r>0){rrSum+=r; rrCount++;}
        list.push(t.pair);
      }
      const avgRR=rrCount?(rrSum/rrCount).toFixed(2):"N/A";
      return `Trades Taken: ${trades.length}\nPairs: ${list.join(", ")}\nTotal PnL: ${totalPNL}\nAverage R:R: ${avgRR}\nGreat work‚Äîreview setups and stay consistent!`;
    }

    saveBtn.onclick = ()=>{
      const trades=getTrades();
      summaryEl.value = autoSummary(trades);
      const data={
        trades,
        dailySummary: summaryEl.value,
        reflection: reflectionEl.value,
        gratitude: gratitudeEl.value,
        goals: goalsEl.value,
        mood: document.querySelector("input[name='mood']:checked")?.value||""
      };
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
      alert("‚úÖ Entry saved with automatic summary!");
    };

    function load(){
      const raw=localStorage.getItem(STORAGE_KEY);
      if(!raw) return createTradeRow();
      const data=JSON.parse(raw);
      (data.trades||[]).forEach(t=>createTradeRow(t));
      if(!data.trades?.length) createTradeRow();
      summaryEl.value=data.dailySummary||"";
      reflectionEl.value=data.reflection||"";
      gratitudeEl.value=data.gratitude||"";
      goalsEl.value=data.goals||"";
      if(data.mood){
        const m=document.querySelector(`input[value='${data.mood}']`);
        if(m) m.checked=true;
      }
      updateWords();
    }

    function updateWords(){
      const words=reflectionEl.value.trim().split(/\s+/).filter(Boolean);
      wordCountEl.textContent=`Words: ${words.length}`;
    }

    reflectionEl.addEventListener("input",updateWords);
    load();
  </script>
</body>
</html>
