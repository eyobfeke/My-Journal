<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Daily Journal</title>
  <!-- keep your existing stylesheet if any -->
  <link rel="stylesheet" href="../style.css" />
  <style>
    /* Minimal styling for the restored sections.
       This deliberately does not override site-level theme classes. */
    :root {
      --accent: #007bff;
      --card-bg: #ffffff;
      --muted: #666;
    }

    body {
      font-family: "Segoe UI", system-ui, -apple-system, "Helvetica Neue", Arial;
      margin: 0;
      padding: 0;
      background: transparent; /* let global theme handle background */
      color: inherit; /* keep theme's color */
    }

    header {
      padding: 18px 12px;
      text-align: center;
      border-bottom: 1px solid rgba(0,0,0,0.06);
      background: transparent;
    }

    header h1 {
      margin: 0 0 6px 0;
      font-size: 18px;
      font-weight: 600;
    }

    header a.back {
      display: inline-block;
      margin-top: 6px;
      color: var(--accent);
      text-decoration: none;
      font-weight: 600;
    }

    main.container {
      max-width: 980px;
      margin: 18px auto;
      padding: 18px;
      background: var(--card-bg);
      border-radius: 10px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.06);
    }

    /* --- Keep trade table style untouched visually (simple neutral) --- */
    #trade-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 18px;
    }
    #trade-table th, #trade-table td {
      border: 1px solid rgba(0,0,0,0.12);
      padding: 8px;
      text-align: center;
    }
    #trade-table th {
      background: rgba(0,0,0,0.03);
      font-weight: 700;
    }

    .btn {
      display: inline-block;
      padding: 8px 12px;
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 700;
    }
    .btn.ghost {
      background: transparent;
      color: var(--accent);
      border: 1px solid rgba(0,0,0,0.08);
    }

    section {
      margin-bottom: 16px;
    }

    h2.section-title {
      margin: 6px 0 10px 0;
      font-size: 16px;
      font-weight: 700;
    }

    textarea, input[type="text"], select {
      width: 100%;
      box-sizing: border-box;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid rgba(0,0,0,0.12);
      font-family: inherit;
      font-size: 14px;
      color: inherit;
      background: #fff;
    }

    /* don't override dark theme backgrounds if body.dark exists
       just make textarea subtle; theme will override if present */
    body.dark textarea, body.dark input[type="text"] {
      background: #222;
      border-color: rgba(255,255,255,0.06);
      color: #eaeaea;
    }

    textarea { min-height: 110px; resize: vertical; }

    .small-meta {
      font-size: 13px;
      color: var(--muted);
      text-align: right;
      margin-top: 6px;
    }

    /* screenshot preview */
    .screenshot-preview {
      display: block;
      max-width: 140px;
      max-height: 120px;
      object-fit: cover;
      border-radius: 6px;
      margin-top: 8px;
      cursor: zoom-in;
      border: 1px solid rgba(0,0,0,0.08);
    }

    /* modal enlarge */
    .modal {
      display: none;
      position: fixed;
      z-index: 1200;
      inset: 0;
      background: rgba(0,0,0,0.85);
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .modal img { max-width: 95%; max-height: 95%; border-radius: 8px; }

    @media (max-width:720px) {
      main.container { margin: 12px; padding: 12px; }
      .screenshot-preview { max-width: 120px; }
    }
  </style>
</head>
<body>
  <header>
    <h1 id="entry-date">Loading...</h1>
    <a class="back" href="../index.html">‚Üê Back to Calendar</a>
  </header>

  <main class="container">
    <!-- TRADE DETAIL TABLE (kept intact) -->
    <section id="trade-section">
      <button id="add-trade" class="btn">Add Trade</button>

      <table id="trade-table" aria-label="Trade details">
        <thead>
          <tr>
            <th>Pair</th>
            <th>Entry</th>
            <th>Exit</th>
            <th>R:R</th>
            <th>Notes</th>
            <th>PNL</th>
            <th>Screenshot</th>
          </tr>
        </thead>
        <tbody>
          <!-- initial empty row preserved to match your existing layout -->
          <tr>
            <td><input type="text" class="pair" placeholder="e.g. EUR/USD"></td>
            <td><input type="text" class="entry" placeholder="Entry price"></td>
            <td><input type="text" class="exit" placeholder="Exit price"></td>
            <td><input type="text" class="rr" placeholder="e.g. 1:2"></td>
            <td><textarea class="notes" placeholder="Setup notes..."></textarea></td>
            <td><input type="text" class="pnl" placeholder="+50 / -20"></td>
            <td>
              <input type="file" accept="image/*" class="screenshot-input">
              <img class="screenshot-preview" style="display:none" alt="screenshot preview">
            </td>
          </tr>
        </tbody>
      </table>
    </section>

    <!-- RESTORED DAILY SECTIONS (exactly as you requested) -->
    <section id="daily-summary">
      <h2 class="section-title">Daily Summary</h2>
      <textarea id="dailySummary" placeholder="Summarize your overall performance today..."></textarea>
    </section>

    <section id="mood-section">
      <h2 class="section-title">Mood Tracker</h2>
      <div>
        <label><input type="radio" name="mood" value="Happy"> Happy</label>
        &nbsp;&nbsp;
        <label><input type="radio" name="mood" value="Neutral"> Neutral</label>
        &nbsp;&nbsp;
        <label><input type="radio" name="mood" value="Sad"> Sad</label>
        &nbsp;&nbsp;
        <label><input type="radio" name="mood" value="Stressed"> Stressed</label>
        &nbsp;&nbsp;
        <label><input type="radio" name="mood" value="Confident"> Confident</label>
      </div>
    </section>

    <section id="reflection-section">
      <h2 class="section-title">Reflection</h2>
      <textarea id="reflection" placeholder="Write your reflections for the day..."></textarea>
      <div class="small-meta"><span id="wordCount">Words: 0</span></div>
    </section>

    <section id="gratitude-section">
      <h2 class="section-title">Gratitude List</h2>
      <textarea id="gratitude" placeholder="List things you‚Äôre grateful for today..."></textarea>
    </section>

    <section id="goals-section">
      <h2 class="section-title">Daily Goals</h2>
      <textarea id="goals" placeholder="What are your main goals today?"></textarea>
    </section>

    <section id="save-section">
      <button id="saveEntry" class="btn">üíæ Save Entry</button>
    </section>
  </main>

  <!-- modal for image enlarge -->
  <div id="imgModal" class="modal" aria-hidden="true">
    <img id="modalImg" alt="enlarged screenshot">
  </div>

  <script>
    // ===== Utilities & DOM references =====
    const params = new URLSearchParams(window.location.search);
    const date = params.get('date') || (new Date()).toISOString().slice(0,10);
    document.getElementById('entry-date').textContent = date ? `Journal for ${date}` : 'Journal Entry';

    const TRADE_TBODY = document.querySelector('#trade-table tbody');
    const ADD_TRADE_BTN = document.getElementById('add-trade');

    const dailySummaryEl = document.getElementById('dailySummary');
    const reflectionEl = document.getElementById('reflection');
    const gratitudeEl = document.getElementById('gratitude');
    const goalsEl = document.getElementById('goals');
    const wordCountEl = document.getElementById('wordCount');

    const saveBtn = document.getElementById('saveEntry');

    const IMG_MODAL = document.getElementById('imgModal');
    const MODAL_IMG = document.getElementById('modalImg');

    const STORAGE_KEY = `entry-${date}`;

    // ===== Word count for reflection =====
    function updateWordCount() {
      const words = reflectionEl.value.trim().split(/\s+/).filter(Boolean);
      wordCountEl.textContent = `Words: ${words.length}`;
    }
    reflectionEl.addEventListener('input', updateWordCount);

    // ===== Add trade row (keeps structure untouched) =====
    function createTradeRow(data = {}) {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><input type="text" class="pair" placeholder="e.g. EUR/USD" value="${escapeHtml(data.pair||'')}"></td>
        <td><input type="text" class="entry" placeholder="Entry price" value="${escapeHtml(data.entry||'')}"></td>
        <td><input type="text" class="exit" placeholder="Exit price" value="${escapeHtml(data.exit||'')}"></td>
        <td><input type="text" class="rr" placeholder="e.g. 1:2" value="${escapeHtml(data.rr||'')}"></td>
        <td><textarea class="notes" placeholder="Setup notes...">${escapeHtml(data.notes||'')}</textarea></td>
        <td><input type="text" class="pnl" placeholder="+50 / -20" value="${escapeHtml(data.pnl||'')}"></td>
        <td>
          <input type="file" accept="image/*" class="screenshot-input">
          <img class="screenshot-preview" style="display:${data.screenshot ? 'block' : 'none'}" src="${data.screenshot||''}" alt="screenshot preview">
        </td>
      `;
      // wire up screenshot input change
      const input = tr.querySelector('.screenshot-input');
      const img = tr.querySelector('.screenshot-preview');
      input.addEventListener('change', (ev) => {
        const f = ev.target.files && ev.target.files[0];
        if (!f) return;
        const reader = new FileReader();
        reader.onload = (e) => {
          img.src = e.target.result;
          img.style.display = 'block';
          img.dataset.base64 = e.target.result; // store base64 on img for saving
          img.addEventListener('click', () => openModal(e.target.result));
        };
        reader.readAsDataURL(f);
      });
      // if an existing screenshot was provided, add click to open
      if (data.screenshot) {
        img.addEventListener('click', () => openModal(data.screenshot));
        img.dataset.base64 = data.screenshot;
      }
      TRADE_TBODY.appendChild(tr);
    }

    // escape minimal to avoid breaking attributes
    function escapeHtml(s) {
      return String(s).replaceAll('&','&amp;').replaceAll('"','&quot;').replaceAll('<','&lt;').replaceAll('>','&gt;');
    }

    // add initial row if none exist
    if (!TRADE_TBODY.querySelector('tr')) {
      createTradeRow();
    }

    ADD_TRADE_BTN.addEventListener('click', () => createTradeRow());

    // ===== Modal functions =====
    function openModal(src) {
      MODAL_IMG.src = src;
      IMG_MODAL.style.display = 'flex';
      IMG_MODAL.setAttribute('aria-hidden', 'false');
    }
    IMG_MODAL.addEventListener('click', () => {
      IMG_MODAL.style.display = 'none';
      IMG_MODAL.setAttribute('aria-hidden', 'true');
      MODAL_IMG.src = '';
    });

    // ===== Save & Load logic (localStorage) =====
    function gatherData() {
      const trades = Array.from(TRADE_TBODY.querySelectorAll('tr')).map(tr => {
        const pair = tr.querySelector('.pair')?.value || '';
        const entry = tr.querySelector('.entry')?.value || '';
        const exit = tr.querySelector('.exit')?.value || '';
        const rr = tr.querySelector('.rr')?.value || '';
        const notes = tr.querySelector('.notes')?.value || '';
        const pnl = tr.querySelector('.pnl')?.value || '';
        // prefer attached preview base64 if present
        const imgEl = tr.querySelector('.screenshot-preview');
        const screenshot = imgEl?.dataset?.base64 || imgEl?.src || '';
        return { pair, entry, exit, rr, notes, pnl, screenshot };
      });

      const mood = document.querySelector('input[name="mood"]:checked')?.value || '';
      return {
        date,
        mood,
        dailySummary: dailySummaryEl.value || '',
        reflection: reflectionEl.value || '',
        gratitude: gratitudeEl.value || '',
        goals: goalsEl.value || '',
        trades
      };
    }

    function saveEntry() {
      try {
        const data = gatherData();
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        alert('‚úÖ Entry saved locally');
      } catch (err) {
        console.error(err);
        alert('‚ùå Save failed');
      }
    }

    function loadEntry() {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return;
      try {
        const data = JSON.parse(raw);
        dailySummaryEl.value = data.dailySummary || '';
        reflectionEl.value = data.reflection || '';
        gratitudeEl.value = data.gratitude || '';
        goalsEl.value = data.goals || '';
        // set mood radio
        if (data.mood) {
          const m = document.querySelector(`input[name="mood"][value="${CSS.escape(data.mood)}"]`);
          if (m) m.checked = true;
          else { // if value contains spaces or different label, fallback
            Array.from(document.querySelectorAll('input[name="mood"]')).forEach(r => {
              if (r.value.toLowerCase() === (data.mood||'').toLowerCase()) r.checked = true;
            });
          }
        }
        // trades: clear current rows and re-create from saved
        TRADE_TBODY.innerHTML = '';
        (data.trades||[]).forEach(t => createTradeRow(t));
        // if no trades in saved, make one empty
        if (!(data.trades && data.trades.length)) createTradeRow();
        updateWordCount();
      } catch (err) {
        console.error('load error', err);
      }
    }

    saveBtn.addEventListener('click', saveEntry);

    // update word count helper
    function updateWordCount() {
      const words = reflectionEl.value.trim().split(/\s+/).filter(Boolean);
      wordCountEl.textContent = `Words: ${words.length}`;
    }
    reflectionEl.addEventListener('input', updateWordCount);

    // On load, populate saved entry
    loadEntry();
    updateWordCount();

    // Make sure preview images are clickable if they exist (for entries loaded)
    // (createTradeRow already wires click handlers when loading)
  </script>
</body>
</html>
