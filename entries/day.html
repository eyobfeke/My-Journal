<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Journal ‚Äî Day</title>
  <link rel="stylesheet" href="../style.css">
  <style>
    /* page-specific */
    .page-main{max-width:1200px;margin:28px auto;padding:30px;background:var(--card);border-radius:12px;border:1px solid var(--border);box-shadow:0 6px 18px rgba(0,0,0,0.04)}
    .back{display:block;margin-bottom:12px;color:var(--accent);text-decoration:none}
    .flex-row{display:flex;gap:20px;align-items:flex-start;flex-wrap:wrap}
    .col{flex:1 1 48%}
    h1{margin-top:0}
    table{width:100%;border-collapse:collapse;margin-bottom:10px}
    th,td{padding:8px;border:1px solid var(--border);text-align:center}
    input, textarea{width:100%;padding:8px;border-radius:6px;border:1px solid #ccc}
    .btn {background:var(--accent);color:#fff;border:none;padding:10px 14px;border-radius:8px;cursor:pointer}
    .small{font-size:13px;color:var(--muted)}
    .img-small{max-width:120px;max-height:90px;border-radius:6px;border:1px solid var(--border);display:block;margin-top:6px}
    .add-trade {background:#28a745}
    .trade-rows {margin-bottom:12px}
    .actions {margin-top:14px;text-align:right}
    @media(max-width:820px){ .col{flex:1 1 100%} }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="brand">ü™∂ My Journal</div>
    <div class="controls">
      <button id="theme-toggle-day">‚òæ</button>
    </div>
  </div>

  <main class="page-main">
    <a href="../index.html" class="back">‚Üê Back to Calendar</a>
    <h1 id="date-title">Journal for ‚Äî</h1>

    <!-- TRADE DETAILS (top) -->
    <section>
      <h2>üìà Trade Details</h2>

      <div class="trade-rows">
        <table id="trade-table">
          <thead>
            <tr>
              <th>Pair</th><th>Entry</th><th>Exit</th><th>R/R</th><th>Notes</th><th>Screenshot</th><th>PnL</th><th>Remove</th>
            </tr>
          </thead>
          <tbody id="trade-body"></tbody>
        </table>
      </div>

      <div style="display:flex;gap:10px;align-items:center;">
        <button id="add-trade" class="btn add-trade">‚ûï Add Trade</button>
        <div class="small" style="margin-left:8px">P&L auto-calculated (exit - entry). Leave Exit blank for ongoing trades.</div>
      </div>
    </section>

    <!-- TRADE SUMMARY -->
    <section>
      <h2>üìä Trade Summary</h2>
      <div class="flex-row">
        <div class="col">
          <table>
            <thead><tr><th>Win</th><th>Loss</th><th>Ongoing</th><th>PNL</th></tr></thead>
            <tbody>
              <tr>
                <td><input id="sum-win" type="number"></td>
                <td><input id="sum-loss" type="number"></td>
                <td><input id="sum-ongoing" type="number"></td>
                <td><input id="sum-pnl" type="number" step="0.01"></td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="col">
          <table>
            <thead><tr><th>R/R</th><th>Win Rate</th><th>Missed Wins</th><th>Invalid Loss</th></tr></thead>
            <tbody>
              <tr>
                <td><input id="sum-rr" type="text" placeholder="1:2"></td>
                <td><input id="sum-winrate" type="text" placeholder="%"></td>
                <td><input id="sum-missed" type="number"></td>
                <td><input id="sum-invalid" type="number"></td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Reflection / Gratitude / Goals / Mood -->
    <section class="flex-row">
      <div class="col">
        <h2>üìù Daily Reflection</h2>
        <textarea id="reflection-text" rows="5" placeholder="Write your reflections..."></textarea>
      </div>
      <div class="col">
        <h2>üôè Gratitude</h2>
        <textarea id="gratitude-text" rows="5" placeholder="List things you're grateful for..."></textarea>
      </div>
    </section>

    <section class="flex-row">
      <div class="col">
        <h2>üéØ Tomorrow's Goals</h2>
        <textarea id="goals-text" rows="3" placeholder="Tomorrow's goals..."></textarea>
      </div>
      <div class="col">
        <h2>üåû Mood</h2>
        <label><input type="radio" name="mood" value="happy"> Happy</label><br>
        <label><input type="radio" name="mood" value="neutral"> Neutral</label><br>
        <label><input type="radio" name="mood" value="sad"> Sad</label><br>
        <label><input type="radio" name="mood" value="stressed"> Stressed</label><br>
        <label><input type="radio" name="mood" value="confident"> Confident</label>
      </div>
    </section>

    <div class="actions">
      <button id="save-btn" class="btn">üíæ Save Entry</button>
    </div>
  </main>

  <script>
    // local theme toggle (keep same behavior)
    const themeToggleDay = document.getElementById('theme-toggle-day');
    if(localStorage.getItem('theme') === 'dark') document.body.classList.add('dark');
    themeToggleDay.textContent = document.body.classList.contains('dark') ? '‚òÄÔ∏è' : '‚òæ';
    themeToggleDay.addEventListener('click', () => {
      const dark = document.body.classList.toggle('dark');
      localStorage.setItem('theme', dark ? 'dark' : 'light');
      themeToggleDay.textContent = dark ? '‚òÄÔ∏è' : '‚òæ';
    });

    // helpers
    const params = new URLSearchParams(window.location.search);
    const date = params.get('date') || (new Date()).toISOString().split('T')[0];
    document.getElementById('date-title').textContent = `Journal for ${date}`;
    const key = `entry-${date}`;

    function createTradeRow(t = {}) {
      // t: {pair, entry, exit, rr, note, imgData}
      const tr = document.createElement('tr');

      tr.innerHTML = `
        <td><input class="pair" type="text" value="${escapeHtml(t.pair||'')}" placeholder="EUR/USD"></td>
        <td><input class="entry" type="number" step="0.01" value="${t.entry||''}"></td>
        <td><input class="exit" type="number" step="0.01" value="${t.exit||''}"></td>
        <td><input class="rr" type="text" value="${escapeHtml(t.rr||'')}"></td>
        <td><textarea class="note" rows="2">${escapeHtml(t.note||'')}</textarea></td>
        <td>
          <input class="imgfile" type="file" accept="image/*">
          ${t.imgData? `<img class="img-small" src="${t.imgData}">` : ''}
        </td>
        <td><input class="pnl" type="text" readonly value="${computePnlDisplay(t.entry,t.exit)}"></td>
        <td><button class="remove-btn">‚úñ</button></td>
      `;

      // image file input handler -> preview
      const fileInput = tr.querySelector('.imgfile');
      const imgEl = tr.querySelector('.img-small');
      fileInput.addEventListener('change', (e) => {
        const f = e.target.files[0];
        if(!f) return;
        const reader = new FileReader();
        reader.onload = ev => {
          // add preview image element if not present
          if(imgEl){
            imgEl.src = ev.target.result;
          } else {
            const img = document.createElement('img');
            img.className = 'img-small';
            img.src = ev.target.result;
            fileInput.parentElement.appendChild(img);
          }
        };
        reader.readAsDataURL(f);
      });

      // remove button
      tr.querySelector('.remove-btn').addEventListener('click', ()=> tr.remove());

      // update pnl when entry/exit change
      const entryIn = tr.querySelector('.entry');
      const exitIn = tr.querySelector('.exit');
      const pnlIn = tr.querySelector('.pnl');
      function updatePnl(){
        pnlIn.value = computePnlDisplay(entryIn.value, exitIn.value);
      }
      entryIn.addEventListener('input', updatePnl);
      exitIn.addEventListener('input', updatePnl);

      return tr;
    }

    function computePnlDisplay(entry, exit){
      const e = parseFloat(entry);
      const x = parseFloat(exit);
      if(isNaN(e) || isNaN(x)) return ''; // ongoing or missing
      const p = +(x - e).toFixed(2);
      return p;
    }

    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, (m)=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }

    // populate saved content if present
    function loadSaved(){
      const raw = localStorage.getItem(key);
      if(!raw) {
        // start with one empty row
        document.getElementById('trade-body').appendChild(createTradeRow());
        return;
      }
      try{
        const obj = JSON.parse(raw);
        // trades array support
        const trades = Array.isArray(obj.trades) ? obj.trades : (obj.trades ? obj.trades : []);
        if(trades.length>0){
          trades.forEach(t=> {
            document.getElementById('trade-body').appendChild(createTradeRow(t));
            // restore image if stored as imgData: need to insert after row creation
            const lastRow = document.getElementById('trade-body').lastElementChild;
            if(t.imgData){
              const container = lastRow.querySelector('td:nth-child(6)');
              const img = document.createElement('img');
              img.className='img-small';
              img.src = t.imgData;
              container.appendChild(img);
            }
          });
        } else {
          // fallback: if older single fields exist
          const rowData = {
            pair: obj.pair||'',
            entry: obj.entry||'',
            exit: obj.exit||'',
            rr: obj.rr||'',
            note: obj['valid-note']||obj['setup-notes']||''
          };
          document.getElementById('trade-body').appendChild(createTradeRow(rowData));
        }

        // other fields
        const map = {
          'sum-win':'win','sum-loss':'loss','sum-ongoing':'ongoing','sum-pnl':'pnl',
          'sum-rr':'riskreward','sum-winrate':'winrate','sum-missed':'missed','sum-invalid':'invalid'
        };
        for(const id in map){
          if(obj[map[id]] !== undefined) document.getElementById(id).value = obj[map[id]];
        }
        if(obj['reflection-text']) document.getElementById('reflection-text').value = obj['reflection-text'];
        if(obj['gratitude-text']) document.getElementById('gratitude-text').value = obj['gratitude-text'];
        if(obj['goals-text']) document.getElementById('goals-text').value = obj['goals-text'];
        if(obj.mood) {
          const m = document.querySelector(`input[name="mood"][value="${obj.mood}"]`);
          if(m) m.checked = true;
        }
      } catch(e){
        // start with empty row
        document.getElementById('trade-body').appendChild(createTradeRow());
      }
      // ensure at least one row
      if(document.getElementById('trade-body').children.length===0) document.getElementById('trade-body').appendChild(createTradeRow());
    }

    // Add trade handler
    document.getElementById('add-trade').addEventListener('click', ()=>{
      document.getElementById('trade-body').appendChild(createTradeRow());
    });

    // Save handler: gather trades, including images if any (dataURL)
    document.getElementById('save-btn').addEventListener('click', async ()=>{
      const rows = Array.from(document.querySelectorAll('#trade-body tr'));
      const trades = [];
      for(const r of rows){
        const pair = r.querySelector('.pair').value;
        const entry = r.querySelector('.entry').value;
        const exit = r.querySelector('.exit').value;
        const rr = r.querySelector('.rr').value;
        const note = r.querySelector('.note').value;
        // image: if preview exists use it, else try to read file
        let imgData = '';
        const imgEl = r.querySelector('.img-small');
        if(imgEl && imgEl.src) imgData = imgEl.src;
        else {
          const fileInput = r.querySelector('.imgfile');
          if(fileInput && fileInput.files && fileInput.files[0]){
            imgData = await fileToDataUrl(fileInput.files[0]);
          }
        }
        const pnl = computePnlDisplay(entry, exit);
        trades.push({pair, entry, exit, rr, note, imgData, pnl});
      }

      // summary fields
      const data = {
        trades,
        win: document.getElementById('sum-win').value,
        loss: document.getElementById('sum-loss').value,
        ongoing: document.getElementById('sum-ongoing').value,
        pnl: document.getElementById('sum-pnl').value,
        riskreward: document.getElementById('sum-rr').value,
        winrate: document.getElementById('sum-winrate').value,
        missed: document.getElementById('sum-missed').value,
        invalid: document.getElementById('sum-invalid').value,
        'reflection-text': document.getElementById('reflection-text').value,
        'gratitude-text': document.getElementById('gratitude-text').value,
        'goals-text': document.getElementById('goals-text').value,
        mood: (document.querySelector('input[name="mood"]:checked') || {}).value || ''
      };

      localStorage.setItem(key, JSON.stringify(data));
      alert('‚úÖ Entry saved for ' + date);
      // update calendar summary in index if you go back
    });

    function fileToDataUrl(file){
      return new Promise((res,rej)=>{
        const reader = new FileReader();
        reader.onload = e => res(e.target.result);
        reader.onerror = err => rej(err);
        reader.readAsDataURL(file);
      });
    }

    // load on open
    loadSaved();
  </script>
</body>
</html>
